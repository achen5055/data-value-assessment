{% extends "base.html" %}

{% block title %}{{ assessment.name }} - 评估详情{% endblock %}

{% block page_title %}评估详情：{{ assessment.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- 评估概览 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>评估概览</h5>
                <div class="btn-group">
                    <a href="{{ url_for('visualization.visualize_assessment', assessment_id=assessment.id) }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar me-1"></i>可视化
                    </a>
                    <a href="{{ url_for('assessment.export', assessment_id=assessment.id) }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-download me-1"></i>导出报告
                    </a>
                    <a href="{{ url_for('assessment.assessments') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>返回列表
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="position-relative d-inline-block">
                                <canvas id="scoreChart" width="120" height="120"></canvas>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <h3 class="mb-0">{{ "%.1f"|format(assessment.overall_score) if assessment.overall_score else 0 }}</h3>
                                    <small class="text-muted">综合得分</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <strong>评估状态:</strong><br>
                                    {% if assessment.status == 'completed' %}
                                    <span class="badge bg-success">已完成</span>
                                    {% elif assessment.status == 'running' %}
                                    <span class="badge bg-warning">进行中</span>
                                    {% else %}
                                    <span class="badge bg-danger">失败</span>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <strong>评估类型:</strong><br>
                                    {% if assessment.assessment_type == 'quality' %}
                                    <span class="badge bg-info">数据质量评估</span>
                                    {% elif assessment.assessment_type == 'value' %}
                                    <span class="badge bg-success">数据价值评估</span>
                                    {% else %}
                                    <span class="badge bg-primary">综合评估</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <strong>创建时间:</strong><br>
                                    {{ assessment.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                                <div class="mb-3">
                                    <strong>完成时间:</strong><br>
                                    {% if assessment.completed_at %}
                                    {{ assessment.completed_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <strong>数据集:</strong><br>
                                    {% if assessment.dataset %}
                                    <a href="{{ url_for('data.detail', dataset_id=assessment.dataset.id) }}" class="text-decoration-none">
                                        {{ assessment.dataset.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">数据集已删除</span>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <strong>评估耗时:</strong><br>
                                    {% if assessment.duration %}
                                    {{ assessment.duration }} 秒
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if assessment.description %}
                        <div class="mt-3">
                            <strong>评估描述:</strong><br>
                            <p class="text-muted">{{ assessment.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细评分 -->
        {% if assessment.results %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>详细评分</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for category, score in assessment.results.items() %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">{{ category }}</h6>
                                    <span class="badge {% if score >= 80 %}bg-success{% elif score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ "%.1f"|format(score) }}
                                    </span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar {% if score >= 80 %}bg-success{% elif score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         style="width: {{ score }}%"></div>
                                </div>
                                {% if assessment.details and assessment.details[category] %}
                                <div class="mt-2">
                                    <small class="text-muted">{{ assessment.details[category] }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 评估报告 -->
        {% if assessment.report %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>评估报告</h5>
            </div>
            <div class="card-body">
                <div class="assessment-report">
                    {{ assessment.report|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 问题和建议 -->
        {% if assessment.issues or assessment.recommendations %}
        <div class="row">
            {% if assessment.issues %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>发现的问题</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            {% for issue in assessment.issues %}
                            <li class="mb-2">
                                <i class="fas fa-circle text-warning me-2"></i>
                                {{ issue }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if assessment.recommendations %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>改进建议</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            {% for recommendation in assessment.recommendations %}
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                {{ recommendation }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 创建得分图表
        const scoreCtx = document.getElementById('scoreChart').getContext('2d');
        const overallScore = {{ assessment.overall_score or 0 }};
        
        const scoreChart = new Chart(scoreCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [overallScore, 100 - overallScore],
                    backgroundColor: [
                        getScoreColor(overallScore),
                        '#e9ecef'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                responsive: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });

        function getScoreColor(score) {
            if (score >= 80) return '#28a745';
            if (score >= 60) return '#ffc107';
            return '#dc3545';
        }

        // 打印报告功能
        const printBtn = document.createElement('button');
        printBtn.className = 'btn btn-outline-primary btn-sm';
        printBtn.innerHTML = '<i class="fas fa-print me-1"></i>打印报告';
        printBtn.onclick = function() {
            window.print();
        };
        
        const cardHeader = document.querySelector('.card-header');
        if (cardHeader) {
            cardHeader.querySelector('.btn-group').appendChild(printBtn);
        }
    });
</script>
{% endblock %}